{% extends 'base.html' %}
{% block content %}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

<!-- Calendar CSS -->
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css' rel='stylesheet' />

<div class="container my-4">

  <!-- ✅ START MAIN CARD -->
  <div class="card shadow p-4">
    <div class="card-body">

      <!-- TITLE -->
      <h2 class="card-title mb-4 text-center fw-bold">Expense Dashboard</h2>

      <!-- ✅ FILTER FORM -->
      <h4>Filter Expenses</h4>
      <form method="get" class="mb-3">
        {{ expense_filter.form.as_p }}
        <button type="submit" class="btn btn-primary">Apply Filter</button>
      </form>

      <hr>

      <!-- ✅ TABLE -->
      <h4 class="mt-4">Your Expenses</h4>
      <div class="table-responsive mb-5">
        <table class="table table-striped table-hover">
          <thead class="table-dark">
            <tr>
              <th>Date</th>
              <th>Title</th>
              <th>Category</th>
              <th>Amount (₹)</th>
            </tr>
          </thead>
          <tbody>
            {% for expense in expenses %}
            <tr>
              <td>{{ expense.date }}</td>
              <td>{{ expense.title }}</td>
              <td>{{ expense.category }}</td>
              <td>{{ expense.amount }}</td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="4" class="text-center">No expenses found.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <hr>

      <!-- ✅ GRAPH + CALENDAR ROW -->
      <h4 class="mt-4">Statistics</h4>

      <div class="row mt-3">

        <!-- ✅ GRAPH SECTION -->
        <div class="col-md-6 mb-4">
          <div class="card shadow-sm p-3">
            <h5 class="text-center">Daily Expense Trend</h5>
            <canvas id="expenseChart"></canvas>
          </div>
        </div>

        <!-- ✅ CALENDAR SECTION -->
        <div class="col-md-6 mb-4">
          <div class="card shadow-sm p-3">
            <h5 class="text-center">Expense Calendar</h5>
            <div id="calendar"></div>
          </div>
        </div>

      </div>

    </div>
  </div>
  <!-- ✅ END MAIN CARD -->

</div>


<!-- ✅ JAVASCRIPT CODE -->

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  const ctx = document.getElementById('expenseChart');

  new Chart(ctx, {
    type: 'line',
    data: {
      labels: [{% for m in monthly_data %}'{{ m.date }}',{% endfor %}],
      datasets: [{
        label: 'Expenses (₹)',
        data: [{% for m in monthly_data %}{{ m.total }},{% endfor %}],
        borderWidth: 2,
        borderColor: 'rgb(75, 192, 192)',
        fill: false,
        tension: 0.3
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: { beginAtZero: true }
      }
    }
  });
</script>


<!-- FullCalendar JS -->
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    var calendarEl = document.getElementById('calendar');

    var calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'dayGridMonth',
      height: 450,
      events: [
        {% for e in expenses %}
        {
          title: '{{ e.title }} (₹{{ e.amount }})',
          start: '{{ e.date }}'
        },
        {% endfor %}
      ]
    });

    calendar.render();
  });
</script>

{% endblock %}
